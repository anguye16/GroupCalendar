<!-- This is the landing/home page where users can read about the summary of Group Calendar -->

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Welcome</title>
    <link rel="stylesheet" href="webStyles.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.4/jquery.min.js"></script>
    <script src="https://fb.me/react-15.0.0.js"></script>
    <script src="https://fb.me/react-dom-15.0.0.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-core/5.8.34/browser.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/3.4.0/firebase.js"></script>
    <script src="https://cdn.firebase.com/libs/reactfire/1.0.0/reactfire.min.js"></script>
    <script src="https://d3js.org/d3.v3.min.js"></script>
</head>

<header>
    <a href="index"> <img class="logo" src="grouplogo.png" alt="GroupCalendarLogo" height="200" width="200"></a>
    <ul>
        <li><a href="login">login</a></li>
        <li><a href="signup">sign up</a></li>
        <li><a href="about">about us</a></li>
    </ul>
</header>

<body>

<section>

    Welcome to Group Calendar, a wonderful place to make new friends and find new groups as well as connect with people
    you already know.<br><br>
    Have a group, but not sure when everyone can meet? Want to find people in your area with similar
    likes and interests as you? This might be the thing for you!
    <img class =background src="grouplogo.png" alt="GroupCalendarLogo" height="200" width="200">

</section>

<div id="containerWeather">
    <!-- This element's contents will be replaced with your component. -->
</div>

<section>
    <div>
        <ul class="tabs">
            <li><a class ="tab" onclick="showDetails(this)" id="publicEvenTab" data-tab-desc="list of public events added by members" href="#publicevents">Public Events</a></li>
            <li><a class ="tab" onclick="showDetails(this)" id="donTab" data-tab-desc="list of our most valuable donors" href="#donations">Donations</a></li>
        </ul>
    </div>
</section>

<div class="panel" id="publicevents" >
    <div id="container">

    </div>
</div>

<div class="panel" id="donations">
    <table style="height: 100px; overflow-y:scroll">
        <tr>
            <th>First Name</th>
            <th>Last Name</th>
            <th>Amount Donated</th>
        </tr>
        <tr>
            <td data-fName = "Bruce">Bruce</td>
            <td>Wayne</td>
            <td>$50,000</td>
        </tr>
        <tr>
            <td data-fName = "Tony">Tony</td>
            <td>Stark</td>
            <td>$65,000</td>
        </tr>
        <tr>
            <td data-fName = Lex>Lex</td>
            <td>Luthor</td>
            <td>$45,000</td>
        </tr>
        <tr>
            <td data-fName = Black>Black</td>
            <td>Panther</td>
            <td>$100,000</td>
        </tr>
        <tr>
            <td>Oliver</td>
            <td>Queen</td>
            <td>$10,000</td>
        </tr>
    </table>
</div>

<section></section>

<script type="text/babel">
    "use strict";
    // Initialize Firebase
    var config = {
        apiKey: "AIzaSyC-qT42afFTH5hPZ_v9wvbrV0sLEggRjHc",
        authDomain: "groupcalendar-82b96.firebaseapp.com",
        databaseURL: "https://groupcalendar-82b96.firebaseio.com",
        storageBucket: "groupcalendar-82b96.appspot.com",
        messagingSenderId: "519544706410"
    };
    firebase.initializeApp(config);

    function show(id) {
        $('.tab')// Select all elements with tab class
                .removeClass('selected')// Remove the "selected" class
                .filter // Filter all tabs with function below
                (function () {
                    return (this.hash === id);
                }) // Add the tag with the corresponding link
                .addClass('selected');

        $('.panel')// Select elements with class "panel"
                .hide() // Hide all elements with class "panel"
                .filter(id) // Select the element with the filtered id
                .show(); // Unhide element that has been selected
    }

    // Calls the functions above when the # changes
    $(window).on('hashchange', function(){
        show(location.hash);
    });

    // Initially shows the first panel
    show('#publicevents');

    //React scripts
    /*
    Title: 06bonusreact index.htnml
    Author: Jon Bell
    Date: 2016
    Code version: Version 1
    Availability: Github
     */
    var EventList = React.createClass({
        render: function () {
            var eventsRef = firebase.database().ref('events');
            var _this = this; //In the subcomponent, "this" will refer to window, so need to save "this" here
            var createItem = function (item, key) {
                return (<div key={key}><input type="text" placeholder="Event name" onChange={_this.props.onChange.bind(null, item['.key'])}
                                              value={item.text}/>

                    <input type="date" placeholder="Date" onChange={_this.props.onChangeDate.bind(null, item['.key'])}
                           value={item.date}/>

                    <button onClick={_this.props.removeItem.bind(null, item['.key'])}>&#x2716;</button>

                </div>);
            };
            return <ul>{this.props.items.map(createItem)}</ul>;
        }
    });
    var Events = React.createClass({
        mixins: [ReactFireMixin],
        getInitialState: function () {
            return {items: []};
        },
        componentWillMount: function () {
            this.fireRef = firebase.database().ref('events');

            this.bindAsArray(this.fireRef, "items");
        },
        onChange: function (fireKey, event) {
            this.fireRef.child(fireKey).update({"text": event.target.value});
        },
        onChangeDate: function (fireKey, event) {
            this.fireRef.child(fireKey).update({"date": event.target.value});
        },
        removeItem: function (key) {
            this.fireRef.child(key).remove();
        },

        handleAdd: function (e) {
            this.fireRef.push({"text": "", "date": ""});
        },
        render: function () {
            return (
                    <div>
                        <h3>Events</h3>
                        <EventList items={this.state.items} removeItem={this.removeItem} onChange={this.onChange} onChangeDate={this.onChangeDate}/>
                        <button onClick={this.handleAdd}>New</button>
                    </div>
            );
        }
    });

    ReactDOM.render(<Events/>, document.getElementById('container'));

    //weather script

    var Weather = React.createClass({
        getInitialState: function() {
            return { showResults: false };
        },

        componentDidMount: function() {
            $.ajax('https://api.wunderground.com/api/42fac7a19d94e096/conditions/q/VA/fairfax.json',{
                url: this.props.url,
                dataType: 'json',
                cache: false,
                success: function(json) {

                    this.setState(
                            {city : json.current_observation.display_location.full,
                                icon:'<img src=' + json.current_observation.icon_url + '>',
                                rain: "Rain last hour " + json.current_observation.precip_1hr_in,
                                weather:json.current_observation.temperature_string + " " + json.current_observation.weather,
                                time:json.current_observation.observation_time_rfc822
                            });
                    console.log(this.state.time);
                }.bind(this),
                error: function(xhr, status, err) {
                    console.error(this.props.url, status, err.toString());
                }.bind(this)
            });
        },

        componentWillUnmount: function() {
            this.serverRequest.abort();
        },

        render: function() {
            return (
                    <div>
                        <div>{this.state.city}</div>
                        <div>{this.state.rain}</div>
                        <div>{this.state.weather}</div>
                        <div>{this.state.time}</div>
                    </div>
            );
        }
    });

    ReactDOM.render( <Weather><h1></h1></Weather>, document.getElementById('containerWeather'));

    //D3 Coding
    /*
     Title: Collapsible Indented Tree
     Author: Mike Bostock
     Date: 2016
     Code version: Version 1
     Availability: Github/D3 Example Gallery
     */
    var margin = {top: 30, right: 20, bottom: 30, left: 20},
            width = 960 - margin.left - margin.right,
            barHeight = 20,
            barWidth = width * .8;

    var i = 0,
            duration = 400,
            root;

    var tree = d3.layout.tree()
            .nodeSize([0, 20]);

    var diagonal = d3.svg.diagonal()
            .projection(function(d) { return [d.y, d.x]; });

    var svg = d3.select("body").append("svg")
            .attr("width", width + margin.left + margin.right)
            .append("g")
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

    //This creates a new empty data structure and fills it by going through the original data
    //Turns flat data structure to hierarchical

    var data = [
        {  "key": "#1", "name": "First Event", "model": "Fenwick Library", "size": "320" },
        {  "key": "#1", "name": "First Event", "model": "10-13-2016", "size": "320" },
        {  "key": "#2", "name": "Second Event", "model": "Johnson Center", "size": "320" },
        {  "key": "#2", "name": "Second Event", "model": "10-13-2016", "size": "320" }
    ];

    var eventsRef = firebase.database().ref('events');

    eventsRef.orderByChild("text").on("child_added", function(childSnapshot){
        data.push({  "name": JSON.stringify(childSnapshot.val().text), "model": "value5", "size": "320" });
    });

    console.log(data);

    var newData = { name :"Events", children : [] },
            levels = ["key","name"];

    // For each data row, loop through the expected levels traversing the output tree
    data.forEach(function(d){
        // Keep this as a reference to the current level
        var depthCursor = newData.children;
        // Go down one level at a time
        levels.forEach(function( property, depth ){

            // Look to see if a branch has already been created
            var index;
            depthCursor.forEach(function(child,i){
                if ( d[property] == child.name ) index = i;
            });
            // Add a branch if it isn't there
            if ( isNaN(index) ) {
                depthCursor.push({ name : d[property], children : []});
                index = depthCursor.length - 1;
            }
            // Now reference the new child array as we go deeper into the tree
            depthCursor = depthCursor[index].children;
            // This is a leaf, so add the last element to the specified branch
            if ( depth === levels.length - 1 ) depthCursor.push({ name : d.model, size : d.size });
        });
    });

    update(root = newData);

    function update(source) {

        // Compute the flattened node list. TODO use d3.layout.hierarchy.
        var nodes = tree.nodes(root);

        var height = Math.max(500, nodes.length * barHeight + margin.top + margin.bottom);

        d3.select("svg").transition()
                .duration(duration)
                .attr("height", height);

        d3.select(self.frameElement).transition()
                .duration(duration)
                .style("height", height + "px");

        // Compute the "layout".
        nodes.forEach(function(n, i) {
            n.x = i * barHeight;
        });

        // Update the nodes…
        var node = svg.selectAll("g.node")
                .data(nodes, function(d) { return d.id || (d.id = ++i); });

        var nodeEnter = node.enter().append("g")
                .attr("class", "node")
                .attr("transform", function(d) { return "translate(" + source.y0 + "," + source.x0 + ")"; })
                .style("opacity", 1e-6);

        // Enter any new nodes at the parent's previous position.
        nodeEnter.append("rect")
                .attr("y", -barHeight / 2)
                .attr("height", barHeight)
                .attr("width", barWidth)
                .style("fill", color)
                .on("click", click);

        nodeEnter.append("text")
                .attr("dy", 3.5)
                .attr("dx", 5.5)
                .text(function(d) { return d.name; });

        // Transition nodes to their new position.
        nodeEnter.transition()
                .duration(duration)
                .attr("transform", function(d) { return "translate(" + d.y + "," + d.x + ")"; })
                .style("opacity", 1);

        node.transition()
                .duration(duration)
                .attr("transform", function(d) { return "translate(" + d.y + "," + d.x + ")"; })
                .style("opacity", 1)
                .select("rect")
                .style("fill", color);

        // Transition exiting nodes to the parent's new position.
        node.exit().transition()
                .duration(duration)
                .attr("transform", function(d) { return "translate(" + source.y + "," + source.x + ")"; })
                .style("opacity", 1e-6)
                .remove();

        // Update the links…
        var link = svg.selectAll("path.link")
                .data(tree.links(nodes), function(d) { return d.target.id; });

        // Enter any new links at the parent's previous position.
        link.enter().insert("path", "g")
                .attr("class", "link")
                .attr("d", function(d) {
                    var o = {x: source.x0, y: source.y0};
                    return diagonal({source: o, target: o});
                })
                .transition()
                .duration(duration)
                .attr("d", diagonal);

        // Transition links to their new position.
        link.transition()
                .duration(duration)
                .attr("d", diagonal);

        // Transition exiting nodes to the parent's new position.
        link.exit().transition()
                .duration(duration)
                .attr("d", function(d) {
                    var o = {x: source.x, y: source.y};
                    return diagonal({source: o, target: o});
                })
                .remove();

        // Stash the old positions for transition.
        nodes.forEach(function(d) {
            d.x0 = d.x;
            d.y0 = d.y;
        });
    }

    // Toggle children on click.
    function click(d) {
        if (d.children) {
            d._children = d.children;
            d.children = null;
        } else {
            d.children = d._children;
            d._children = null;
        }
        update(d);
    }

    function color(d) {
        return d._children ? "#3182bd" : d.children ? "#c6dbef" : "#fd8d3c";
    }

</script>

</body>

<footer>
	<ul>
		<li><a href="about">about us</a></li>
	</ul>
</footer>

</html>
